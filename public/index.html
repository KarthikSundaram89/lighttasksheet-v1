<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LightTaskSheet ‚Äî Fixed</title>
<link rel="stylesheet" href="style.css">
<style>
.col-number {
  width: 100px !important;
  min-width: 100px !important;
  max-width: 100px !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: left !important;
}

.col-number .num {
  text-align: left !important;
  padding-left: 8px;
}

table.sheet th {
  position: relative;
  resize: horizontal;
  overflow: auto;
  min-width: 100px;
}

table.sheet th:not(.col-number) {
  border-right: 2px solid #ddd;
}

table.sheet td textarea, table.sheet td select {
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  min-height: 20px;
  resize: vertical;
  border: none;
  outline: none;
  font-family: inherit;
  font-size: inherit;
  width: 100%;
  padding: 4px;
  background: transparent !important;
}

table.sheet td textarea:focus, table.sheet td select:focus, table.sheet td input:focus {
  background: transparent !important;
  outline: 1px solid #007bff;
}

.sub-row .h-num {
  padding-left: 15px;
  font-size: 0.9em;
  color: #666;
}

.sub-row-level-2 .h-num {
  padding-left: 25px;
  font-size: 0.85em;
  color: #888;
}

.sub-row-level-3 .h-num {
  padding-left: 35px;
  font-size: 0.8em;
  color: #aaa;
}
</style>
</head>
<body>

<header class="app-header">
  <h1 class="app-title">LightTaskSheet</h1>
  <div class="spacer"></div>
  <button id="helpBtn" class="help-btn" title="Help / Shortcuts">?</button>
  <span id="userTag" class="username-tag" aria-hidden="true"></span>
  <div style="display:flex;gap:8px;align-items:center">
    <input id="username" placeholder="username" style="padding:8px;border-radius:6px;border:1px solid #e9f1fb" />
    <input id="password" placeholder="password" type="password" style="padding:8px;border-radius:6px;border:1px solid #e9f1fb" />
    <button id="loginBtn" class="btn primary">Login</button>
    <button id="registerBtn" class="btn ghost">Register</button>
    <button id="resetPasswordBtn" class="btn ghost">Reset Password</button>
    <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
    <button id="adminBtn" class="btn ghost" style="display:none;">Admin</button>
  </div>
</header>

<div class="controls">
  <button id="addRowBtn" class="btn ghost">+ Add row</button>
  <button id="addColBtn" class="btn ghost">+ Add column</button>
  <button id="saveBtn" class="btn primary">Save</button>
  <button id="collapseAllBtn" class="btn ghost">Collapse All</button>
  <button id="expandAllBtn" class="btn ghost">Expand All</button>
  <button id="exportBtn" class="btn ghost">Export JSON</button>
  <button id="exportXlsBtn" class="btn ghost">Export Excel (.csv)</button>
  <button id="importBtn" class="btn ghost">Import JSON</button>
  <input id="importFile" type="file" accept="application/json" style="display:none;" onchange="importJSON()">
</div>

<main class="sheet-card" role="main" aria-label="Task sheet">
  <!-- Table will be injected here -->
</main>

<footer style="text-align: center; padding: 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 20px;">
  Made with ‚ù§Ô∏è using Amazon Q
</footer>

<div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true" style="display:none">
  <div class="modal" role="document">
    <h3>Help & Keyboard Shortcuts</h3>
    <p>Useful keyboard shortcuts and quick tips.</p>
    <ul>
      <li><strong>Ctrl + Enter</strong> ‚Äî Add new row</li>
      <li><strong>Tab</strong> (from last column) ‚Äî Add new row at same hierarchy</li>
      <li><strong>Ctrl + S</strong> ‚Äî Save</li>
      <li><strong>Ctrl + E</strong> ‚Äî Export JSON</li>
      <li><strong>Ctrl + Z</strong> ‚Äî Undo</li>
    </ul>
    <button id="closeModal" class="btn primary">Close</button>
  </div>
</div>

<div id="resetModal" class="modal-backdrop" role="dialog" aria-hidden="true" style="display:none">
  <div class="modal" role="document">
    <h3>Reset Password</h3>
    <p>Enter your username and new password:</p>
    <input id="resetUsername" placeholder="Username" style="width:100%;margin:8px 0;padding:8px;border:1px solid #ccc;border-radius:4px;">
    <input id="resetPassword" type="password" placeholder="New Password" style="width:100%;margin:8px 0;padding:8px;border:1px solid #ccc;border-radius:4px;">
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button id="confirmReset" class="btn primary">Reset Password</button>
      <button id="cancelReset" class="btn ghost">Cancel</button>
    </div>
  </div>
</div>

<div id="adminModal" class="modal-backdrop" role="dialog" aria-hidden="true" style="display:none">
  <div class="modal" role="document" style="max-width:600px;">
    <h3>Admin Panel</h3>
    <div id="usersList" style="margin:16px 0;"></div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button id="refreshUsers" class="btn primary">Refresh</button>
      <button id="closeAdmin" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<script>
// Global variables
const API = '/api';
const TOKEN_KEY = 'lts_token';
const USER_KEY = 'lts_user';
const PALETTE = ['#ffd8a8','#c6f6d5','#dbeafe','#fde68a','#fbcfe8','#e6e6fa','#d1fae5','#fce7f3'];

let sheet = {
  columns: [
    {name:'Timestamp',type:'date',color:PALETTE[2]}, 
    {name:'Task',type:'text',color:PALETTE[0]}, 
    {name:'Notes',type:'text',color:PALETTE[1]},
    {name:'Status',type:'dropdown',color:PALETTE[3],options:['To be started','In Progress','Pending','Completed'],protected:true}
  ],
  rows: []
};

let tableEl = null;

// Utility functions
function uid(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); }
function nowISO(){ return new Date().toISOString(); }
function fmtLocal(iso){ if(!iso) return ''; try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

// API functions
function apiFetch(path, opts={}){
  opts.headers = opts.headers || {};
  if(!opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';
  const token = localStorage.getItem(TOKEN_KEY);
  if(token) opts.headers['Authorization'] = 'Bearer ' + token;
  return fetch(API + path, opts).then(async res => {
    const json = await res.json().catch(()=>null);
    return Object.assign(res, { json });
  });
}

// Core functions
function addRow(){
  console.log('Adding row...');
  const cells = new Array(sheet.columns.length).fill('');
  cells[0] = nowISO();
  
  // Set default status for Status column
  const statusColIndex = sheet.columns.findIndex(col => col.name === 'Status');
  if(statusColIndex !== -1) {
    cells[statusColIndex] = 'To be started';
  }
  
  const r = { id: uid(), cells, sub:false, parent:null, collapsed:false };
  sheet.rows.push(r);
  renderTable();
}

function addColumn(){
  const name = prompt('Column name:', 'Column ' + (sheet.columns.length + 1));
  if(name === null) return;
  
  const type = prompt('Column type (text/date/number/dropdown):', 'text');
  if(!['text', 'date', 'number', 'dropdown'].includes(type)) {
    alert('Invalid type. Using text.');
    type = 'text';
  }
  
  const col = { name: name, type: type, color: PALETTE[sheet.columns.length % PALETTE.length] };
  
  if(type === 'dropdown') {
    const options = prompt('Dropdown options (comma separated):', 'Option 1,Option 2,Option 3');
    if(options) {
      col.options = options.split(',').map(opt => opt.trim());
    } else {
      col.options = ['Option 1', 'Option 2'];
    }
  }
  
  sheet.columns.push(col);
  for(const r of sheet.rows) r.cells.push('');
  renderTable();
}

function deleteColumn(){
  if(sheet.columns.length <= 1) {
    alert('Cannot delete all columns');
    return;
  }
  
  const colNames = sheet.columns.map((c, i) => `${i}: ${c.name}`).join('\n');
  const index = prompt(`Delete which column? Enter number:\n${colNames}`);
  const colIndex = parseInt(index);
  
  if(isNaN(colIndex) || colIndex < 0 || colIndex >= sheet.columns.length) {
    alert('Invalid column number');
    return;
  }
  
  if(confirm(`Delete column "${sheet.columns[colIndex].name}"?`)) {
    sheet.columns.splice(colIndex, 1);
    for(const r of sheet.rows) r.cells.splice(colIndex, 1);
    renderTable();
  }
}

function addSubRow(parentIndex){
  const parent = sheet.rows[parentIndex];
  if(!parent) return;
  
  const cells = new Array(sheet.columns.length).fill('');
  cells[0] = nowISO();
  
  // Set default status for Status column
  const statusColIndex = sheet.columns.findIndex(col => col.name === 'Status');
  if(statusColIndex !== -1) {
    cells[statusColIndex] = 'To be started';
  }
  
  const r = { id: uid(), cells, sub:true, parent:parent.id, collapsed:false };
  
  // Insert after parent and any existing sub-rows
  let insertIndex = parentIndex + 1;
  while(insertIndex < sheet.rows.length && sheet.rows[insertIndex].sub && sheet.rows[insertIndex].parent === parent.id) {
    insertIndex++;
  }
  
  sheet.rows.splice(insertIndex, 0, r);
  renderTable();
}

function toggleCollapse(parentIndex){
  const parent = sheet.rows[parentIndex];
  if(!parent || parent.sub) return;
  
  parent.collapsed = !parent.collapsed;
  renderTable();
}

function deleteColumnByIndex(colIndex){
  if(sheet.columns.length <= 1) {
    alert('Cannot delete all columns');
    return;
  }
  
  if(sheet.columns[colIndex].protected) {
    alert('This column cannot be deleted');
    return;
  }
  
  if(confirm(`Delete column "${sheet.columns[colIndex].name}"?`)) {
    sheet.columns.splice(colIndex, 1);
    for(const r of sheet.rows) r.cells.splice(colIndex, 1);
    renderTable();
  }
}

function computeHierNumber(rowIndex) {
  const row = sheet.rows[rowIndex];
  if(row.sub) {
    // Find parent number and sub-row count
    let parentNum = 0;
    let subNum = 0;
    
    // Find the parent row
    for(let i = rowIndex - 1; i >= 0; i--) {
      if(sheet.rows[i].id === row.parent) {
        if(!sheet.rows[i].sub) {
          // Parent is a main row - count main rows before it
          for(let j = 0; j <= i; j++) {
            if(!sheet.rows[j].sub) parentNum++;
          }
        } else {
          // Parent is a sub-row - get its number
          return computeHierNumber(i) + '.' + (countSubRowsWithParent(row.parent, rowIndex) + 1);
        }
        break;
      }
    }
    
    // Count sub-rows with same parent up to current row
    subNum = countSubRowsWithParent(row.parent, rowIndex) + 1;
    
    return `${parentNum}.${subNum}`;
  } else {
    // Count parent rows up to current position
    let parentNum = 0;
    for(let i = 0; i <= rowIndex; i++) {
      if(!sheet.rows[i].sub) parentNum++;
    }
    return parentNum.toString();
  }
}

function getNestingLevel(row) {
  if (!row.sub) return 0;
  
  let level = 0;
  let currentRow = row;
  
  // Keep going up the parent chain until we reach a non-sub row
  while (currentRow.sub && currentRow.parent) {
    level++;
    // Find the parent row
    let parentFound = false;
    for (let i = 0; i < sheet.rows.length; i++) {
      if (sheet.rows[i].id === currentRow.parent) {
        currentRow = sheet.rows[i];
        parentFound = true;
        break;
      }
    }
    if (!parentFound) break;
  }
  
  return level;
}

function countSubRowsWithParent(parentId, upToIndex) {
  let count = 0;
  for(let i = 0; i < upToIndex; i++) {
    if(sheet.rows[i].sub && sheet.rows[i].parent === parentId) {
      count++;
    }
  }
  return count;
}

function deleteRow(index){
  if(confirm('Delete this row?')) {
    const row = sheet.rows[index];
    
    // If deleting a parent row, also delete its sub-rows
    if(!row.sub) {
      const toDelete = [index];
      for(let i = index + 1; i < sheet.rows.length; i++) {
        if(sheet.rows[i].sub && sheet.rows[i].parent === row.id) {
          toDelete.push(i);
        } else {
          break;
        }
      }
      // Delete in reverse order to maintain indices
      toDelete.reverse().forEach(i => sheet.rows.splice(i, 1));
    } else {
      sheet.rows.splice(index, 1);
    }
    
    renderTable();
  }
}

function renderTable(){
  console.log('Rendering table...');
  
  if(!tableEl) {
    const container = document.querySelector('main.sheet-card');
    if(!container) {
      console.error('Container not found');
      return;
    }
    tableEl = document.createElement('table');
    tableEl.className = 'sheet';
    tableEl.id = 'sheetTable';
    container.appendChild(tableEl);
  }

  tableEl.innerHTML = '';
  
  // Create header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  
  // Number column
  const thNum = document.createElement('th');
  thNum.className = 'col-number sticky-left';
  thNum.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><strong>#</strong></div>';
  headerRow.appendChild(thNum);
  
  // Column headers
  sheet.columns.forEach((col, i) => {
    const th = document.createElement('th');
    const deleteBtn = col.protected ? '' : `<span onclick="deleteColumnByIndex(${i})" style="cursor:pointer; color:#dc3545; font-weight:bold;" title="Delete column">üóëÔ∏è</span>`;
    th.innerHTML = `
      <div style="padding:8px; display:flex; justify-content:space-between; align-items:center;">
        <span>${col.name} (${col.type})</span>
        ${deleteBtn}
      </div>
    `;
    headerRow.appendChild(th);
  });
  
  // Actions column
  const thActions = document.createElement('th');
  thActions.textContent = 'Actions';
  headerRow.appendChild(thActions);
  
  thead.appendChild(headerRow);
  tableEl.appendChild(thead);
  
  // Create body
  const tbody = document.createElement('tbody');
  
  // Build collapsed map
  const collapsed = {};
  sheet.rows.forEach(r => {
    if(!r.sub && r.id) collapsed[r.id] = !!r.collapsed;
  });
  
  sheet.rows.forEach((row, i) => {
    // Skip sub-rows if parent is collapsed
    if(row.sub && row.parent && collapsed[row.parent]) return;
    
    const tr = document.createElement('tr');
    if(row.sub) {
      tr.classList.add('sub-row');
      tr.style.backgroundColor = '#f8f9fa';
      
      // Add nesting level class for indentation
      const nestLevel = getNestingLevel(row);
      if (nestLevel >= 2) tr.classList.add('sub-row-level-2');
      if (nestLevel >= 3) tr.classList.add('sub-row-level-3');
    }
    
    // Row number with hierarchy
    const tdNum = document.createElement('td');
    tdNum.className = 'col-number sticky-left';
    const numDiv = document.createElement('div');
    numDiv.className = 'num';
    numDiv.innerHTML = '<span class="h-num">' + computeHierNumber(i) + '</span>';
    tdNum.appendChild(numDiv);
    tr.appendChild(tdNum);
    
    // Row cells
    row.cells.forEach((cellValue, ci) => {
      const td = document.createElement('td');
      const col = sheet.columns[ci];
      
      if(col.type === 'date') {
        const inp = document.createElement('input');
        inp.type = 'datetime-local';
        if(cellValue) {
          try {
            const d = new Date(cellValue);
            const pad = n => String(n).padStart(2,'0');
            inp.value = d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
          } catch(e) {}
        }
        inp.addEventListener('change', () => {
          row.cells[ci] = inp.value ? new Date(inp.value).toISOString() : '';
        });
        td.appendChild(inp);
      } else if(col.type === 'dropdown') {
        const select = document.createElement('select');
        select.style.width = '100%';
        select.style.border = 'none';
        select.style.outline = 'none';
        select.style.fontFamily = 'inherit';
        select.style.fontSize = 'inherit';
        select.style.padding = '4px';
        
        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '';
        select.appendChild(emptyOption);
        
        // Add dropdown options
        col.options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });
        
        select.value = cellValue || '';
        select.addEventListener('change', () => {
          row.cells[ci] = select.value;
        });
        
        td.appendChild(select);
      } else {
        const inp = document.createElement('textarea');
        inp.value = cellValue || '';
        inp.style.width = '100%';
        inp.style.minHeight = '20px';
        inp.style.resize = 'vertical';
        inp.style.border = 'none';
        inp.style.outline = 'none';
        inp.style.fontFamily = 'inherit';
        inp.style.fontSize = 'inherit';
        
        // Add visual indicator for sub-row tasks
        if(row.sub && ci === 1) {
          inp.style.paddingLeft = '20px';
          inp.placeholder = 'Sub-task...';
        }
        
        inp.addEventListener('input', () => {
          row.cells[ci] = inp.value;
          // Auto-resize textarea
          inp.style.height = 'auto';
          inp.style.height = inp.scrollHeight + 'px';
        });
        
        // Tab navigation - create new row when tabbing from last column
        inp.addEventListener('keydown', (e) => {
          if(e.key === 'Tab' && !e.shiftKey && ci === sheet.columns.length - 1) {
            e.preventDefault();
            // Create new row at same hierarchy level
            if(row.sub) {
              // Create sub-row with same parent
              const cells = new Array(sheet.columns.length).fill('');
              cells[0] = nowISO();
              const newRow = { id: uid(), cells, sub: true, parent: row.parent, collapsed: false };
              
              // Insert after current row
              let insertIndex = i + 1;
              sheet.rows.splice(insertIndex, 0, newRow);
            } else {
              // Create main row
              addRow();
            }
            renderTable();
            
            // Focus first cell of new row
            setTimeout(() => {
              const newRowInputs = document.querySelectorAll('table.sheet tbody tr:last-child textarea, table.sheet tbody tr:last-child input');
              if(newRowInputs.length > 0) {
                newRowInputs[0].focus();
              }
            }, 50);
          }
        });
        
        // Initial resize
        setTimeout(() => {
          inp.style.height = 'auto';
          inp.style.height = inp.scrollHeight + 'px';
        }, 0);
        
        td.appendChild(inp);
      }
      
      tr.appendChild(td);
    });
    
    // Actions
    const tdActions = document.createElement('td');
    tdActions.style.display = 'flex';
    tdActions.style.gap = '4px';
    tdActions.style.alignItems = 'center';
    tdActions.style.background = 'transparent';
    tdActions.style.padding = '4px';
    
    if(!row.sub) {
      // Collapse/expand button for parent rows only
      const collapseBtn = document.createElement('span');
      collapseBtn.textContent = row.collapsed ? '‚ñ∂' : '‚ñº';
      collapseBtn.style.cursor = 'pointer';
      collapseBtn.style.padding = '4px';
      collapseBtn.style.background = 'transparent';
      collapseBtn.title = row.collapsed ? 'Expand' : 'Collapse';
      collapseBtn.onclick = () => toggleCollapse(i);
      tdActions.appendChild(collapseBtn);
    }
    
    // Add sub-row button for all rows (allows nesting)
    const addSubBtn = document.createElement('span');
    addSubBtn.textContent = '‚ûï';
    addSubBtn.style.cursor = 'pointer';
    addSubBtn.style.padding = '4px';
    addSubBtn.style.background = 'transparent';
    addSubBtn.title = 'Add sub-row';
    addSubBtn.onclick = () => addSubRow(i);
    tdActions.appendChild(addSubBtn);
    
    // Delete button
    const deleteBtn = document.createElement('span');
    deleteBtn.textContent = 'üóëÔ∏è';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.padding = '4px';
    deleteBtn.style.color = '#dc3545';
    deleteBtn.style.background = 'transparent';
    deleteBtn.title = 'Delete row';
    deleteBtn.onclick = () => deleteRow(i);
    tdActions.appendChild(deleteBtn);
    
    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
  
  tableEl.appendChild(tbody);
  console.log('Table rendered with', sheet.rows.length, 'rows');
}

// Auth functions
async function doLogin(u,p){
  const res = await apiFetch('/login', { 
    method:'POST', 
    body: JSON.stringify({ username: u, password: p }) 
  });
  if(!res.ok) throw new Error('Login failed');
  localStorage.setItem(TOKEN_KEY, res.json.token);
  localStorage.setItem(USER_KEY, res.json.username);
  await loadSheet(res.json.username);
}

async function doRegister(u,p){
  const res = await apiFetch('/register', { 
    method:'POST', 
    body: JSON.stringify({ username: u, password: p }) 
  });
  if(!res.ok) throw new Error('Register failed');
  alert('User created ‚Äî please login.');
}

async function resetPassword(username, newPassword){
  const res = await apiFetch('/reset-password', {
    method: 'POST',
    body: JSON.stringify({ username, newPassword })
  });
  if(!res.ok) throw new Error('Password reset failed');
  return res.json;
}

async function getAllUsers(){
  const res = await apiFetch('/admin/users');
  if(!res.ok) throw new Error('Failed to fetch users');
  return res.json.users;
}

async function deleteUser(username){
  const res = await apiFetch('/admin/delete-user', {
    method: 'POST',
    body: JSON.stringify({ username })
  });
  if(!res.ok) throw new Error('Failed to delete user');
  return res.json;
}

function doLogout(){
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
  sheet.rows = [];
  renderTable();
}

function showToast(message = 'Saved ‚úì', duration = 2000) {
  // Remove existing toast
  const existingToast = document.getElementById('toast');
  if(existingToast) existingToast.remove();
  
  // Create new toast
  const toast = document.createElement('div');
  toast.id = 'toast';
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // Auto remove after duration
  setTimeout(() => {
    if(toast.parentNode) toast.remove();
  }, duration);
}

async function saveSheet(){
  const user = localStorage.getItem(USER_KEY);
  if(!user) return alert('Login first');
  try {
    const res = await apiFetch(`/sheet/${user}`, {
      method: 'POST',
      body: JSON.stringify({ sheet })
    });
    if(res.ok) {
      showToast('Saved ‚úì');
    } else {
      throw new Error('Save failed');
    }
  } catch(err) {
    alert('Save error: ' + err.message);
  }
}

async function loadSheet(username){
  const res = await apiFetch(`/sheet/${username}`);
  if(res.ok && res.json && res.json.sheet) {
    sheet = res.json.sheet;
    
    // Check if Status column exists, if not add it
    const hasStatusColumn = sheet.columns.some(col => col.name === 'Status');
    if(!hasStatusColumn) {
      sheet.columns.push({
        name: 'Status',
        type: 'dropdown',
        color: PALETTE[3],
        options: ['To be started','In Progress','Pending','Completed'],
        protected: true
      });
      
      // Add Status cell to all existing rows
      sheet.rows.forEach(row => {
        row.cells.push('To be started');
      });
    }
    
    renderTable();
  }
}

function exportJSON(){
  // Create export data with hierarchy numbers
  const exportData = {
    ...sheet,
    rows: sheet.rows.map((row, i) => ({
      ...row,
      hierarchyNumber: computeHierNumber(i),
      nestingLevel: getNestingLevel(row)
    }))
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'sheet.json';
  link.click();
}

function exportExcel(){
  // Simple CSV export (Excel can open CSV files)
  let csv = '#,' + sheet.columns.map(c => c.name).join(',') + '\n';
  
  sheet.rows.forEach((row, i) => {
    const hierarchyNum = computeHierNumber(i);
    const nestLevel = getNestingLevel(row);
    
    // Add consistent indentation - 2 spaces per level
    const indentedNum = '  '.repeat(nestLevel) + hierarchyNum;
    
    const csvRow = [indentedNum, ...row.cells].map(cell => {
      if(typeof cell === 'string' && cell.includes(',')) {
        return `"${cell.replace(/"/g, '""')}"`;
      }
      return cell || '';
    }).join(',');
    csv += csvRow + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'sheet.csv';
  link.click();
}

function importJSON(){
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if(!imported.columns || !imported.rows) {
        throw new Error('Invalid file format');
      }
      
      // Clean up imported rows (remove hierarchy info if present, keep core data)
      const cleanRows = imported.rows.map(row => ({
        id: row.id,
        cells: row.cells,
        sub: row.sub,
        parent: row.parent,
        collapsed: row.collapsed || false
      }));
      
      sheet = {
        columns: imported.columns,
        rows: cleanRows
      };
      
      renderTable();
      alert('Import successful!');
    } catch(err) {
      alert('Import error: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// Initialize
document.addEventListener('DOMContentLoaded', function(){
  console.log('Initializing...');
  
  // Check for existing login
  const token = localStorage.getItem(TOKEN_KEY);
  const user = localStorage.getItem(USER_KEY);
  if(token && user) {
    // Auto-login user
    document.getElementById('username').style.display = 'none';
    document.getElementById('password').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = '';
    document.getElementById('userTag').textContent = user;
    document.getElementById('userTag').style.display = 'inline-block';
    if(user === 'admin') {
      document.getElementById('adminBtn').style.display = '';
    }
    // Load user's sheet
    loadSheet(user);
  }
  
  // Event listeners
  document.getElementById('addRowBtn').onclick = addRow;
  document.getElementById('addColBtn').onclick = addColumn;
  document.getElementById('saveBtn').onclick = saveSheet;
  document.getElementById('exportBtn').onclick = exportJSON;
  document.getElementById('exportXlsBtn').onclick = exportExcel;
  document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
  
  document.getElementById('collapseAllBtn').onclick = () => {
    sheet.rows.forEach(r => { if(!r.sub) r.collapsed = true; });
    renderTable();
  };
  
  document.getElementById('expandAllBtn').onclick = () => {
    sheet.rows.forEach(r => { if(!r.sub) r.collapsed = false; });
    renderTable();
  };
  
  document.getElementById('loginBtn').onclick = async () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    try {
      await doLogin(u,p);
      // Hide login fields
      document.getElementById('username').style.display = 'none';
      document.getElementById('password').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('registerBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = '';
      document.getElementById('userTag').textContent = u;
      document.getElementById('userTag').style.display = 'inline-block';
      // Show admin button for admin user
      if(u === 'admin') {
        document.getElementById('adminBtn').style.display = '';
      }
    } catch(err) {
      alert(err.message);
    }
  };
  
  document.getElementById('registerBtn').onclick = async () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    try {
      await doRegister(u,p);
    } catch(err) {
      alert(err.message);
    }
  };
  
  document.getElementById('logoutBtn').onclick = () => {
    doLogout();
    // Show login fields
    document.getElementById('username').style.display = '';
    document.getElementById('password').style.display = '';
    document.getElementById('loginBtn').style.display = '';
    document.getElementById('registerBtn').style.display = '';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('userTag').style.display = 'none';
    document.getElementById('adminBtn').style.display = 'none';
  };
  
  // Help modal
  document.getElementById('helpBtn').onclick = () => {
    document.getElementById('modal').style.display = 'flex';
  };
  document.getElementById('closeModal').onclick = () => {
    document.getElementById('modal').style.display = 'none';
  };
  
  // Reset password modal
  document.getElementById('resetPasswordBtn').onclick = () => {
    document.getElementById('resetModal').style.display = 'flex';
  };
  document.getElementById('cancelReset').onclick = () => {
    document.getElementById('resetModal').style.display = 'none';
  };
  document.getElementById('confirmReset').onclick = async () => {
    const username = document.getElementById('resetUsername').value.trim();
    const password = document.getElementById('resetPassword').value;
    if(!username || !password) {
      alert('Please fill in both fields');
      return;
    }
    try {
      await resetPassword(username, password);
      alert('Password reset successful!');
      document.getElementById('resetModal').style.display = 'none';
      document.getElementById('resetUsername').value = '';
      document.getElementById('resetPassword').value = '';
    } catch(err) {
      alert('Reset failed: ' + err.message);
    }
  };
  
  // Admin modal
  document.getElementById('adminBtn').onclick = async () => {
    document.getElementById('adminModal').style.display = 'flex';
    await loadUsersList();
  };
  document.getElementById('closeAdmin').onclick = () => {
    document.getElementById('adminModal').style.display = 'none';
  };
  document.getElementById('refreshUsers').onclick = loadUsersList;
  
  async function loadUsersList() {
    try {
      const users = await getAllUsers();
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '<h4>Users:</h4>';
      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #ddd;margin:4px 0;border-radius:4px;';
        userDiv.innerHTML = `
          <span>${user}</span>
          <button onclick="deleteUserConfirm('${user}')" class="btn ghost" style="color:#dc3545;">Delete</button>
        `;
        usersList.appendChild(userDiv);
      });
    } catch(err) {
      alert('Failed to load users: ' + err.message);
    }
  }
  
  window.deleteUserConfirm = async function(username) {
    if(username === 'admin') {
      alert('Cannot delete admin user');
      return;
    }
    if(confirm(`Delete user "${username}"? This will also delete their data.`)) {
      try {
        await deleteUser(username);
        alert('User deleted successfully');
        await loadUsersList();
      } catch(err) {
        alert('Delete failed: ' + err.message);
      }
    }
  };
  
  // Initial render
  if(sheet.rows.length === 0) {
    addRow();
  } else {
    renderTable();
  }
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + Enter = Add new row
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      addRow();
    }
    
    // Ctrl/Cmd + S = Save
    if((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      saveSheet();
    }
    
    // Ctrl/Cmd + E = Export JSON
    if((e.ctrlKey || e.metaKey) && e.key === 'e') {
      e.preventDefault();
      exportJSON();
    }
  });
});
</script>

</body>
</html>
